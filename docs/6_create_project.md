<div style="page-break-before:always;">
</div>

# <a name="create_project"></a>6. Создание проекта

Для использования инструмента следует установить *Natch* и зависимости (подробнее в разделе [Установка и настройка Natch](2_setup.md#setup_natch)).

Инструмент *Natch* состоит из нескольких взаимосвязанных частей:

* Модифицированный эмулятор QEMU (расширенный механизмами анализа помеченных данных, инструментирования и поддержки плагинов)
* Набор плагинов для интроспекции виртуальных машин
* Командный интерфейс для работы с инструментом
* Конфигурационные файлы

Интерес для пользователя представляют последние два пункта. Работа с *Natch* построена на использовании оберток над
виртуальной машиной и утилитами, чтобы максимально упростить работу с инструментом. Она начинается с команды
`natch create`, с помощью которой создаются проекты.

Создав проект, вы получите возможность запускать инструмент в режимах записи и воспроизвдения (подробнее в разделе
[Запись и воспроизведение сценариев](8_scenario_work.md#record_replay)), а так же главный конфигурационный файл `natch.cfg`,
содержащий основные настройки инструмента.
Вообще в *Natch* используется несколько конфигурационных файлов, ознакомиться с ними можно в разделе
[Конфигурационные файлы Natch](17_app_configs.md#app_configs) или по ходу чтения документации.

Как упоминалось выше, работа с объектами оценки в инструменте организована с помощью проектов (рабочих директорий) --
отдельных папок, содержащих информацию об объекте оценки, необходимую для работы с ним и последующего анализа.

Проект создается на основе образа исследуемой системы и ряда характеристик. Может быть создан двумя способами:
с помощью стандартного интерактивного режима или готового конфигурационного файла. Ниже представлено описание каждого способа.

## <a name="natch_run_script"></a>6.1. Интерактивный режим создания проекта

Командный интерфейс инструмента включает команду `natch create`, которая предназначена для генерации командных строк для запуска *Natch*,
а также для первоначальной настройки инструмента. Команду `natch create` можно запускать из любого расположения,
все необходимое для дальнейшей работы будет помещено в рабочую директорию, указанную пользователем.

В процессе выполнения команды `natch create` пользователю потребуется отвечать на вопросы для формирования параметров запуска инструмента.
На выходе будет сгенерирован файл `qemu_opts.ini`, содержащий опции командной строки для запуска эмлуятора. Командная строка формируется
непосредственно во время выполнения команд `natch record` и `natch replay`.

При необходимости внести изменения в командную строку запуска следует отредактировать файл `qemu_opts.ini`.
Обратите внимание, что некоторые строки начинаются с меток `[rr]`, `[record]`, `[replay]` и `[tuning]`,
это связано с тем, что в режимах тюнинга, записи и воспроизведения командные строки отличаются. Скорее всего,
вы можете не использовать префиксы, но если вдруг, то метки обозначают область применения опций:

* `[rr]` -- для командной строки в режимах записи и воспроизведения;
* `[record]` -- только для режима записи;
* `[replay]` -- только для режима воспроизведения;
* `[tuning]` -- только на этапе тюнинга.

Команда `natch create` имеет ряд параметров, два обязательных, остальные опциональные.
Обязательные параметры:

- `workdir` -- название рабочей директории, которая будет создана для проекта
- `image` -- путь к образу исследуемой системы

Название рабочей директории -- это или просто название папки или полный путь к папке, которая будет создана для хранения всех файлов инструмента.

Если каталог уже существует, будет создан новый с постфиксом `_х`, где x -- это число от 1 до максимально возможного.

Опциональные параметры:

- `-k/--kernel` -- путь к ядру (опция kernel эмулятора QEMU, если ядро ОС не загружается из образа системы)
- `-o/--os-name` -- название операционной системы, для которой будет использован инструмент (по умолчанию Linux, предоставляется выбор из следующих вариантов: Linux, FreeBSD, Win7, Win8, Win8.1, Win10)
- `-c/--config` -- путь к конфигурационному файлу, с помощью которого можно автоматически создать проект с заданными характеристиками (подробнее в разделе \
[Создание проекта с помощью конфигурационного файла](6_create_project.md#natch_save_settings))

Также команду можно запустить с опцией `-h` и получить справку по доступным опциям.

Описание команды и ее параметров представлено ниже:
```text
usage: Natch create [-h] [-k KERNEL] [-o {Linux,FreeBSD,Win7,Win8,Win8.1,Win10}] [-c CONFIG] workdir image

positional arguments:
  workdir               path to project workdir
  image                 path to image

optional arguments:
  -h, --help            show this help message and exit
  -k KERNEL, --kernel KERNEL
                        path to kernel
  -o {Linux,FreeBSD,Win7,Win8,Win8.1,Win10}, --os_name {Linux,FreeBSD,Win7,Win8,Win8.1,Win10}
                        supporting guest OS
  -c CONFIG, --config CONFIG
                        path to project settings
```
Пример запуска команды:
```bash
natch create <workdir> <image> -o Linux
```

Создание проекта проходит в два этапа: на первом пользователю будет задан ряд вопросов, на втором действия будут происходить автоматически.
Во время работы потребуется пароль администратора.

Перед непосредственно работой с пользователем, будет проверена доступность утилиты `natch-qemu-img`, входящей в поставку *Natch*,
так как она будет нужна при записи сценариев.

Список вопросов, которые будут заданы при выполнении команды:

- *Количество оперативной памяти* \
Необходимо указать объем оперативной памяти, выделяемый виртуальной машине. Указывается число в гигабайтах или мегабайтах с соответствующим постфиксом G или M, например 512M.

- *Режим работы эмулятора* \
Эмулятор может быть запущен в графическом (обычном) или текстовом режиме. По умолчанию режим графический, если же необходимо работать в текстовом режиме следует дать ответ *n* или *N*. В этом случае потребуется дополнительная настройка вашего образа (образ из тестового набора уже настроен).

- *Сетевые опции* \
В этом меню пользователь может указать порты, которые необходимо пробросить в виртуальную машину. Запрос на ввод портов появится при выборе ответа *Y/y* или при нажатии клавиши *Enter*. Кроме того, будет предложено помечать не только Destination ports, но и Source. Если это необходимо, следует выбрать ответ *Y/y* или нажать клавишу *Enter*. Порты следует указывать через запятую. На каждый указанный порт будет назначен порт для обращения к машине извне, формироваться они будут следующим образом: первый порт из динамического диапазона для первого пользовательского порта, для остальных путем прибавления единицы. Например, пользователь ввел порты 7777, 8888, получим 49152 и 49153 соответственно.

- *Создание конфигурационного файла для бинарных файлов* \
Для некоторых сценариев работы с *Natch* требуется иметь набор исследуемых бинарных файлов как внутри образа,
так и снаружи. В этом разделе можно загрузить в проект извлеченные из образа файлы. Однако, их может и не быть.
Если модули есть в наличии, то следует нажать *Enter*, *y* или *Y*, в противном случае ввести *n* или *N*.
Если конфигурационный файл нужен, будет предложено указать путь к папке, содержащей бинарные файлы.

- *Получение символьной информации* \
Далее пользователю предложат скачать отладочные символы для системных библиотек, от которых зависит его приложение, и символы ядра операционной системы.
Если отладочные символы нужны (а чаще всего так и есть) то следует нажать *Enter*, *y* или *Y*, в противном случае ввести *n* или *N*. В случае если на предыдущем
шаге модули не были выбраны, то при согласии на получение отладочной информации, она будет скачана для модулей ядра.

- *Генерация конфигурационного файла для ядерных сущностей* \
Следующий вопрос касается конфигурационного файла *task.cfg*. Если вы впервые создаете конфигурацию для образа, следует воспользоваться ответом по умолчанию (*Enter*, *y*, *Y*).
Если же вы уже работали с этим образом и получали конфигурационный файл с этого этапа -- вопрос можно пропустить, но не забудьте скопировать *task.cfg* в рабочую директорию нового проекта. Если не уверены, что файл от нужного образа -- лучше согласиться его создать.

Вопросы закончились, теперь потребуется ввести пароль администратора. Далее будет происходить монтирование образа, удостоверьтесь,
что в системе не работают другие виртуальные машины. После чего работа будет выполняться автоматически, это может занять продолжительное время.

Автоматически будут происходить следующие действия:

- *Получение отладочных символов* \
Этап может быть опущен, если пользователь отказался от скачивания отладочной информации. Если нет, то на этом этапе будет произведено сканирование образа, получение
файлов из него, а так же скачивание отладочных символов разными методами (если один способом не получилось, будет использован другой). Так же будут найдены и скачаны
символы для интерпретаторов Python, символы для Java и C#.

- *Генерация task.cfg* \
Сразу после скачивания модулей будет запущен эмулятор с целью получить информацию о смещениях структур ядра, если конечно была указана необходимость генерации.
В штатной ситуации эмулятор сам завершит работу и наступит следующий этап.
В некоторых случаях эмулятору может не хватить информации для создания конфигурационного файла за время загрузки операционной системы,
если ОС загрузилась и долго ничего не происходит, попробуйте повзаимодействовать с системой (авторизоваться, открыть какой-нибудь файл, и т.д.).

- *Извлечение символьной информации* \
Это последний этап настройки проекта. Будут просканированы все модули и пострена база отладочных символов.

На этом настройка окончена.

Кроме командных строк будет сгенерирована заготовка конфигурационного файла *Natch* (подробнее в разделе [Основной конфигурационный файл natch.cfg](17_app_configs.md#main_config)).
В полученном файле описаны все возможные секции и поля с примерами заполнения,
часть из которых закомментирована. При необходимости этот файл можно отредактировать -- раскомментировать нужные секции и внести актуальные значения параметров.
Имя конфигурационного файла задается по умолчанию, а именно *natch.cfg*.

В процессе работы `natch create` вызывается ряд скриптов, входящих в поставку *Natch*. Если на каком-то из этапов что-то пошло не так или
пользователь отказался от какой-то опции а потом передумал, эти скрипты можно запускать самостоятельно (но не рекомендуется).
Все они оснащены опцией `-h` для получения справки о параметрах. Далее приведено краткое описание скриптов:

- *module_config.py* - генерирует конфигурационный файл *module.cfg*
- *debug_info.py* - скачивает символьную информацию для модулей и ядра, модифицирует *module.cfg*
- *symbol_info.py* - парсит символьную информацию, формирует базу символов. Так же требуется *module.cfg*.

Подробнее с этими и другими скриптами и утилитами *Natch* можно ознакомиться в разделе [Полезные утилиты и скрипты Natch](12_utils.md#utils).

После создания проекта в текущей директории появится еще один файл. Это файл с конфигурацией проекта, речь о котором пойдет в следующем разделе.

## <a name="natch_save_settings"></a>6.2. Создание проекта с помощью конфигурационного файла

При создании проекта пользователь отвечает на вопросы скрипта, однако, все они записываются и могут быть переиспользованы в режиме командной строки вместо интерактивного.
Сохранено это все в файле под названием `settings_<project_name>.ini`, файл располагается в директории, откуда была запущена команда `natch create`.

Сохраняются настройки и в случае нештатного завершения работы скрипта, например, если что-то пошло не так на этапе генерации `task.cfg`.

Конфигурационный файл `settings_test.ini` с полным набором опций выглядит следующим образом:

```ini
[Settings]
version = 7
ram = 4G
text_mode = false
ports_forwarding = true
source_ports = true
ports_str = 8888,7777
module_config = true
module_dir = /home/Quick_Start_Sample/s_1
debug_info = true
tuning = true
```
Некоторые параметры могут отсутствовать, если, например, вы отказались от пробрасывания портов.

Пройдемся по параметрам:

 - `version` -- версия конфигурационного файла `natch.cfg`
 - `ram` -- количество выделенной машине оперативной памяти
 - `text_mode` -- режим работы эмулятора (текстовый или графический)
 - `port_forwarding` -- необходимость проброса портов
 - `source_ports` -- необходимость проброса source портов
 - `ports_str` -- собственно проброшенные порты
 - `module_config` -- необходимость включения модулей в проект
 - `module_dir` -- путь к директории с модулями
 - `debug_info` -- необходимость получения отладочной информации
 - `tuning` -- необходимость генерации `task.cfg`

Если вы хотите создать проект, используя уже готовый конфигурационный файл, но не хотите, например, ждать генерацию `task.cfg`,
просто установите значение параметра `tuning` в `false`.

Использовать конфигурационный файл с настройками проекта можно так:
```bash
natch create <workdir> <image> -c settings_test.ini
```

Единственное что попросит у вас скрипт -- пароль администратора. Остальная работа будет проделана автоматически.

Предполагается, что как минимум однажды проект был создан с помощью скрипта и файл с настройками появится сам,
однако, никто не мешает создать такой файл самостоятельно. Обратить внимание следует только на то, что параметры, связанные
с портами и модулями, захватывают по несколько полей.

Если `ports_forwarding = false`, то поля `source_ports` и `ports_str` не нужны.

Если `module_config = false`, то не нужно указывать поле `module_dir`.




