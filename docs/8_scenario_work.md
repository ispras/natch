<div style="page-break-before:always;">
</div>

# <a name="record_replay"></a>8. Запись и воспроизведение сценариев

Запись и воспроизведение сценариев являются неотъемлемыми частями работы с инструментом.
Процессы записи и воспроизведения инициируются выполнением соответствующих команд:
`natch record` и `natch replay` соответственно.
Обратите внимание, что обе команды необходимо запускать из рабочей директории проекта.

Командная строка для запуска эмулятора формируется на лету, используя файл с опциями (`qemu_opts.ini`),
при необходимости, в него можно вносить изменения. Подробнее про этот файл можно узнать в разделе
[Интерактивный режим создания проекта](6_create_project.md#natch_run_script).


## <a name="record">8.1. Запись сценария

Под записью сценария понимается работа с объектом оценки внутри виртуальной машины, где все действия записываются
с целью многократного автоматического воспроизведения в дальнейшем. В рамках одного проекта можно создавать несколько сценариев,
например, если ваш объект оценки может быть запущен разными способами, или в образе имеется несколько объектов оценки.
В таких ситуациях нет необходимости создавать каждый раз новый проект.
<!-- написать про сценарии более внятно -->

Запись сценария запускается с помощью команды `natch record -s <name>`, где `<name>` -- название сценария.
Обратите внимание, что при указании уже существующего имени, сценарий будет перезаписан.
Сценарии располагаются в отдельных папках с указанными пользователем названиями.
В каждую такую папку после записи помещаются все необходимые для работы сценария файлы --
[конфигурационный файл для помеченных данных](17_app_configs.md#taint_config),
журнал, оверлей, логи сетевых взаимодействий и т.д.

На этапе записи существует важный момент -- необходимо сохранить состояние машины (сделать снапшот) перед тем, как будет произведена работа
непосредственно с объектом оценки.
Тогда воспроизводить сценарий можно будет с момента сохранения снапшота.
В противном случае воспроизводиться будет все, включая загрузку операционной системы, толку от этого не много, а воспроизвести такой
сценарий если и получится, то понадобится очень много времени. Поэтому имеет смысл максимально ограничить полезные действия.
Сохранение состояния машины делается в консоли *Natch* с помощью команды:
```
savevm <name>
```

Где `<name>` название вашего снапшота. Снапшотов в процессе работы можно делать несколько и запоминать их не нужно,
посмотреть список сохраненных снапшотов можно с помощью команды `natch info` (подробнее про [natch info](3_natch_cmd.md#natch_cmd_info)),
а также на этапе воспроизведения будет показан список сохраненных снапшотов.

Завершить работу с эмулятором можно любым удобным способом: ввести команду `q/quit` в консоли *Natch*, просто закрыть окно эмулятора или
"выключить компьютер" средствами гостевой ОС.


## <a name="replay">8.2. Воспроизведение сценария

Когда сценарий записан, можно переходить к этапу воспроизведения, на котором анализируется все что происходило в системе и сбор логов.
Но сначала следует определить источники пометки. Подробнее об источниках в разделе [Определение источников пометки](7_taint_source.md#taint_source).
Определяются они в [конфигурационном файле для помеченных данных](17_app_configs.md#taint_config), отредактировать который можно с помощью
команды `natch edit taint`.

Затем для запуска воспроизведения воспользуйтесь командой `natch replay`.
В связи с тем, что сценариев в проекте может быть несколько, при выполнении команды `natch replay` ситуация может разворачиваться несколькими способами:

* *У нас один сценарий и один снапшот*. В этом случае воспроизведение запустится и отработает без участия пользователя.
* *У нас один сценарий и несколько снапшотов*. Сценарий будет выбран по умолчанию, а для загрузки нужного снапшота нужно будет выбрать его из меню (с помощью стрелочек и клавиши Enter).
* *У нас несколько сценариев и один снапшот (для выбранного сценария)*. Для выбора сценария будет отображено меню с доступными сценариями, снапшот загрузится автоматически.
* *У нас несколько сценариев и несколько снапшотов (для выбранного сценария)*. В обоих случаях будет отображено меню.

Помимо этого команда `natch replay` имеет два необязательных параметра `scenario_name` и `snapshot_name`.
Например, если во время записи был создан сценарий с названием *sample* и в процессе работы был сохранен снапшот с именем *state*,
то запустить воспроизведение с этого момента можно с помощью команды:
```bash
natch replay sample state
```
Обратите внимание, что требуется указывать оба параметра, в противном случае введенный аргумент будет проигнорирован, и команда поведет себя как описано выше.
Если во время работы снапшот не был сохранен, то следует указать имя стартового снапшота, а именно *init*.

На этапе воспроизведения, кроме выбора сценария и снапшота, от пользователя больше ничего не требуется, только дождаться завершения работы эмулятора и
формирования архива `*.tar.zst` с результатами анализа.

Здесь же будет выведена статистика пометок. Если вдруг вы увидели во всех графах нули, значит в вашем сценарии ничего не пометилось, и следует проверить
источники пометок в соответствующем сценарии (`natch edit taint`), а так же удостовериться, что работа с помеченными данными была после того как был сделан снапшот системы.


